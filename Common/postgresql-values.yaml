architecture: replication
global:
  postgresql:
    auth:
      existingSecret: postgresql
      database: postgres
metrics:
  enabled: true
  pgStatStatements: true
primary:
  extraVolumes:
    - name: log-volume
      emptyDir: {}
    - name: otel-config
      configMap:
        name: otel-config
  extendedConfiguration: |
    max_connections = 3001
    shared_preload_libraries = 'pg_stat_statements'
    pg_stat_statements.track = all
    # Logging
    log_destination = 'stderr'
    logging_collector = on
    log_directory = '/bitnami/postgresql/logs'
    log_filename = 'postgresql.log'
    log_truncate_on_rotation = off
    log_rotation_age = 1d
    log_rotation_size = 0
    log_line_prefix = '%m [%p] %q%u@%d %r %a '
    log_error_verbosity = default
    log_min_duration_statement = 1000
    log_statement = 'all'
    log_checkpoints = on
    log_lock_waits = on
    deadlock_timeout = '2s'
    track_io_timing = on
    log_autovacuum_min_duration = 1000
    temp_file_limit = '2GB'
  persistence:
    size: 2Gi
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  extraVolumeMounts:
    - name: log-volume
      mountPath: /bitnami/postgresql/logs
    - name: otel-config
      mountPath: /conf
  securityContext:
    runAsUser: 1001
    runAsGroup: 1001
    fsGroup: 1001
  sidecars:
    - name: log-cleaner
      image: busybox:latest
      command:
        - /bin/sh
        - -c
        - |
          while true; do
            echo "Cleaning old logs for primary..."
            find /bitnami/postgresql/logs -name "postgresql.log.*" -mtime +3 -exec rm {} \;
            sleep 3600
          done
      volumeMounts:
        - name: log-volume
          mountPath: /bitnami/postgresql/logs
    - name: otel-collector
      image: otel/opentelemetry-collector-contrib:0.137.0
      command:
        - /otelcol-contrib
        - --config=/conf/otel-config.yaml
      securityContext:
        runAsUser: 1001
        runAsGroup: 1001
      volumeMounts:
        - name: otel-config
          mountPath: /conf
        - name: log-volume
          mountPath: /bitnami/postgresql/logs
          readOnly: true
      env:
        - name: POSTGRESQL_USERNAME
          value: monitoring
        - name: POSTGRESQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: otel-secrets
              key: monitoring-password
        - name: POSTGRESQL_ENDPOINT
          value: postgresql-primary.dev.svc.cluster.local:5432
        - name: POSTGRESQL_LOG_FILE
          value: /bitnami/postgresql/logs/postgresql.log
        - name: OTLP_DESTINATION_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: otel-secrets
              key: otlp-endpoint
        - name: SIGNOZ_INGESTION_KEY
          valueFrom:
            secretKeyRef:
              name: otel-secrets
              key: signoz-ingestion-key
readReplicas:
  replicaCount: 1
  extraVolumes:
    - name: log-volume
      emptyDir: {}
    - name: otel-config
      configMap:
        name: otel-config
  extendedConfiguration: |
    max_connections = 3001
    shared_preload_libraries = 'pg_stat_statements'
    pg_stat_statements.track = all
    # Logging
    log_destination = 'stderr'
    logging_collector = on
    log_directory = '/bitnami/postgresql/logs'
    log_filename = 'postgresql.log'
    log_truncate_on_rotation = off
    log_rotation_age = 1d
    log_rotation_size = 0
    log_line_prefix = '%m [%p] %q%u@%d %r %a '
    log_error_verbosity = default
    log_min_duration_statement = 1000
    log_statement = 'all'
    log_checkpoints = on
    log_lock_waits = on
    deadlock_timeout = '2s'
    track_io_timing = on
    log_autovacuum_min_duration = 1000
    temp_file_limit = '2GB'
  persistence:
    size: 2Gi
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 400m
      memory: 1Gi
  extraVolumeMounts:
    - name: log-volume
      mountPath: /bitnami/postgresql/logs
    - name: otel-config
      mountPath: /conf
  securityContext:
    runAsUser: 1001
    runAsGroup: 1001
    fsGroup: 1001
  sidecars:
    - name: log-cleaner
      image: busybox:latest
      command:
        - /bin/sh
        - -c
        - |
          while true; do
            echo "Cleaning old logs for replica..."
            find /bitnami/postgresql/logs -name "postgresql.log.*" -mtime +3 -exec rm {} \;
            sleep 3600
          done
      volumeMounts:
        - name: log-volume
          mountPath: /bitnami/postgresql/logs
    - name: otel-collector
      image: otel/opentelemetry-collector-contrib:0.137.0
      command:
        - /otelcol-contrib
        - --config=/conf/otel-config.yaml
      securityContext:
        runAsUser: 1001
        runAsGroup: 1001
      volumeMounts:
        - name: otel-config
          mountPath: /conf
        - name: log-volume
          mountPath: /bitnami/postgresql/logs
          readOnly: true
      env:
        - name: POSTGRESQL_USERNAME
          value: monitoring
        - name: POSTGRESQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: otel-secrets
              key: monitoring-password
        - name: POSTGRESQL_ENDPOINT
          value: postgresql-primary.dev.svc.cluster.local:5432
        - name: POSTGRESQL_LOG_FILE
          value: /bitnami/postgresql/logs/postgresql.log
        - name: OTLP_DESTINATION_ENDPOINT
          valueFrom:
            secretKeyRef:
              name: otel-secrets
              key: otlp-endpoint
        - name: SIGNOZ_INGESTION_KEY
          valueFrom:
            secretKeyRef:
              name: otel-secrets
              key: signoz-ingestion-key
replication:
  enabled: true
  numSynchronousReplicas: 1
  synchronousCommit: "on"
